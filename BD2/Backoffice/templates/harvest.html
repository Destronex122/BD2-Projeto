{% extends 'base.html' %}

{% block title %}Colheita{% endblock %}

{% block content %} 

{% load static %}

<style>
    #harvestTable tbody tr:hover {
        background-color: #f1f1f1; /* Cor de fundo da linha ao passar o rato */
        cursor: pointer; /* Muda o cursor para indicar que a linha é clicável */
    }

    #pesagensTitle {
        display: none; /* Oculta o título das pesagens*/
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination button {
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #e9e8e2;
        background-color: #e9e8e2;
        cursor: pointer;
    }

    .pagination button.active {
        font-weight: bold;
        background-color: #616646;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
</style>

<div class="editable-area newPadding">    
    <div style="display:flex; justify-content: space-between;">
        <h1>Colheitas</h1>
        <div style="justify-self:right; text-align:center;">
            <button type="button" onclick="openAddHarvestModal()">
                <img src="{% static 'add.png' %}" title="Adicionar nova colheita" alt="add" style="height: 25px; width: auto;">
            </button>
        </div>
    </div>
    <p>Selecione uma colheita para visualizar todo o detalhe e as pesagens efetuadas.</p> 
    <!-- Filtros para a tabela -->
    <div class="filters" style="margin-bottom: 20px;">
        <form method="get" id="filterForm" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <div class="form-group">
                    <label for="filterHectares">Hectares:</label>
                    <input 
                        type="number" 
                        step="0.01" 
                        id="filterHectares" 
                        name="filterHectares" 
                        class="form-control" 
                        value="{{ request.GET.filterHectares|default:'' }}" 
                        placeholder="Ex: 10.5">
                </div>
                <div class="form-group">
                    <label for="filterCasta">Casta:</label>
                    <input 
                        type="text" 
                        id="filterCasta" 
                        name="filterCasta" 
                        class="form-control" 
                        value="{{ request.GET.filterCasta|default:'' }}" 
                        placeholder="Ex: Casta X">
                </div>
                <div class="form-group">
                    <label for="filterDataInicio">Data de início:</label>
                    <input 
                        type="date" 
                        id="filterDataInicio" 
                        name="filterDataInicio" 
                        class="form-control" 
                        value="{{ request.GET.filterDataInicio|default:'' }}">
                </div>
                <div class="form-group" style="margin-top: 24px;">
                    <button type="submit" id="applyFilters" class="button">Aplicar</button>
                </div>
            </div>
        </form>
    </div>
    <table class="table table-bordered" id="harvestTable">
        <thead>
            <tr>
                <th>Vinha Hec.</th>
                <th>Casta</th>
                <th>Peso total (kg)</th>
                <th>Preço por tonelada (€)</th>
                <th>Data da última pesagem</th>
                <th>Período</th>
                <th>Previsão do fim da colheita</th>
                <th>Notas</th>
                <th>Data de término</th>
            </tr>
        </thead>
        <tbody>
            {% for colheita in colheitas %}
            <tr  data-colheitaid="{{ colheita.colheitaid }}">
                <td>{{ colheita.vinha_hectares }}</td>
                <td>{{ colheita.casta_nome }}</td>
                <td>{{ colheita.peso_total }}</td>
                <td>{{ colheita.preco_por_tonelada }}</td>
                <td>{{ colheita.data_ultima_pesagem|date:'Y-m-d' }}</td>
                <td>{{ colheita.periodo }}</td>
                <td>{{ colheita.previsao_fim_colheita|date:'Y-m-d' }}</td>
                <td>{% if colheita.terminada %}Sim{% else %}Não{% endif %}</td>
                <td>{{ colheita.data_termino }}</td>
                
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">Nenhuma colheita encontrada.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination">
        {% for page in pages %}
            <button class="button {% if page == current_page %}active{% endif %}" onclick="window.location.href='?page={{ page }}'">
                {{ page }}
            </button>
        {% endfor %}
    </div>
    <br>
    <div id="pesagensTitle">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px; align-items:center;">
            <h2>Pesagens de colheita</h2>
            <button data-toggle="modal" data-target="#addPesagemModal">
                <img src="{% static 'add.png' %}" alt="edit" style="height: 25px; width: 25px;">
            </button>
        </div>   
    </div>
    <div>
        <div class="row" id="cardContainer">
            <!-- As pesagens correspondentes aparecerão aqui -->
        </div>
    </div>

    <!-- Modal para adicionar uma nova pesagem -->
    <div class="modal fade" id="addPesagemModal" tabindex="-1" role="dialog" aria-labelledby="addPesagemModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPesagemModalLabel">Nova pesagem</h5>
                    <div style="display:flex; justify-content: flex-end;">
                        <span data-dismiss="modal" class="close">&times;</span>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="pesagemForm">
                        <div class="form-group">
                            <label for="pesoBruto">Peso bruto (kg)</label>
                            <input type="text" class="form-control" id="pesoBruto" required>
                        </div>
                        <div class="form-group">
                            <label for="pesoLiquido">Peso líquido (kg)</label>
                            <input type="text" class="form-control" id="pesoLiquido" required>
                        </div>
                        <div class="form-group">
                            <label for="dataPesagem">Data de pesagem</label>
                            <input type="date" class="form-control" id="dataPesagem" required>
                        </div>
                        <div style="display:flex; justify-content: flex-end;">
                            <button type="button" class="secondary-button" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="button" >Adicionar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

     <!-- Popup para adicionar nova colheita -->
     <div class="popup-overlay" id="addHarvestModal">
        <div class="popup-content">
            <div class="popup-header">
                <h5>Adicionar colheita</h5>
                <span class="modal-close" onclick="closeAddHarvestModal()">&times;</span>
            </div>
            <br>
            <form id="addHarvestForm" onsubmit="addHarvest(event)">
                <div style="display:flex; gap:10px">
                    <div class="form-group">
                        <label for="newVinha">Vinha:</label>
                        <input type="text" id="newVinha" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newCasta">Casta:</label>
                        <input type="text" id="newCasta" class="form-control" required>
                    </div>
                </div>
                <div style="display:flex; gap:10px">
                    <div class="form-group">
                        <label for="newPesoTotal">Peso total (kg):</label>
                        <input type="number" id="newPesoTotal" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newDataPesagem">Data da última pesagem:</label>
                    <input type="date" id="newDataPesagem" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="newPeriodo">Período:</label>
                    <input type="text" id="newPeriodo" class="form-control" placeholder="Ex: 2024-09-01 a 2024-10-15" required>
                </div>
                <div class="form-group">
                    <label for="newPrevisaoFim">Previsão do fim da colheita:</label>
                    <input type="date" id="newPrevisaoFim" class="form-control" required>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" onclick="closeAddHarvestModal()" class="secondary-button">Cancelar</button>
                    <button type="submit" class="button" style="margin-left: 10px;">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const harvestTable = document.getElementById('harvestTable');
        const cardContainer = document.getElementById('cardContainer');
        const pesagensTitle = document.getElementById('pesagensTitle');

        //DADOS DAS PESAGENS
        const pesagensData = {
            "Vinha A": [
                { pesoBruto: "1000.00 kg", pesoLiquido: "950.00 kg", dataPesagem: "2024-10-01" },
                { pesoBruto: "1100.00 kg", pesoLiquido: "1050.00 kg", dataPesagem: "2024-10-02" },
            ],
            "Vinha B": [
                { pesoBruto: "1200.00 kg", pesoLiquido: "1150.00 kg", dataPesagem: "2024-10-03" },
            ]
        };
        harvestTable.addEventListener('click', function(event) {
    const targetRow = event.target.closest('tr'); // Obtém a linha clicada
    const isHeader = event.target.closest('thead'); // Ignora cliques no cabeçalho
    
    if (targetRow && !isHeader) { 
        const colheitaId = targetRow.getAttribute('data-colheitaid'); // Obtém o atributo "data-colheitaid"
        if (colheitaId) {
            // Redireciona para a URL correspondente
            window.location.href = `/backoffice/harvestdetail/${colheitaId}/`;
        }
    }
});
        //FILTERS
        document.getElementById('applyFilters').addEventListener('click', function() {
            const filterVinha = document.getElementById('filterVinha').value.toLowerCase();
            const filterCasta = document.getElementById('filterCasta').value.toLowerCase();
            const filterDataInicio = document.getElementById('filterDataInicio').value;
            const filterDataFim = document.getElementById('filterDataFim').value;
    
            const rows = document.querySelectorAll('#harvestTable tbody tr');
    
            rows.forEach(row => {
                const vinha = row.getAttribute('data-vinha').toLowerCase();
                const casta = row.getAttribute('data-casta').toLowerCase();
                const dataPesagem = row.getAttribute('data-data-pesagem');
    
                const matchesVinha = !filterVinha || vinha.includes(filterVinha);
                const matchesCasta = !filterCasta || casta.includes(filterCasta);
                const matchesDataInicio = !filterDataInicio || dataPesagem >= filterDataInicio;
                const matchesDataFim = !filterDataFim || dataPesagem <= filterDataFim;
    
                if (matchesVinha && matchesCasta && matchesDataInicio && matchesDataFim) {
                    row.style.display = ''; // Mostra a linha
                } else {
                    row.style.display = 'none'; // Oculta a linha
                }
            });
        });
        
        //POPUP
        function openAddHarvestModal() {
            document.getElementById('addHarvestModal').style.display = 'flex';
        }

        // Function to close the add colheita modal
        function closeAddHarvestModal() {
            document.getElementById('addHarvestModal').style.display = 'none';
        }

        // Function to add a new colheita to the table
        function addHarvest(event) {
            event.preventDefault();

            // Get the values from the form fields
            const newVinha = document.getElementById('newVinha').value;
            const newCasta = document.getElementById('newCasta').value;
            const newPesoTotal = document.getElementById('newPesoTotal').value;
            const newPreco = document.getElementById('newPreco').value;
            const newDataPesagem = document.getElementById('newDataPesagem').value;
            const newPeriodo = document.getElementById('newPeriodo').value;
            const newPrevisaoFim = document.getElementById('newPrevisaoFim').value;
            const newNotas = document.getElementById('newNotas').value;

            // Create a new row for the table with the new colheita data
            const newRow = `
                <tr data-vinha="${newVinha}" data-casta="${newCasta}" data-peso-total="${newPesoTotal}" data-preco="${newPreco}" data-data-pesagem="${newDataPesagem}" data-periodo="${newPeriodo}" data-previsao="${newPrevisaoFim}" data-notas="${newNotas}">
                    <td>${newVinha}</td>
                    <td>${newCasta}</td>
                    <td>${newPesoTotal}</td>
                    <td>${newPreco}</td>
                    <td>${newDataPesagem}</td>
                    <td>${newPeriodo}</td>
                    <td>${newPrevisaoFim}</td>
                    <td>${newNotas}</td>
                    <td>-</td>
                </tr>
            `;

            // Add the new row to the table body
            document.querySelector('#harvestTable tbody').insertAdjacentHTML('beforeend', newRow);

            // Close the modal and reset the form
            closeAddHarvestModal();
            document.getElementById('addHarvestForm').reset();
        }

    </script>
</div>

{% endblock %}