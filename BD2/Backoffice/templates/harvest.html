{% extends 'base.html' %}

{% block title %}Colheita{% endblock %}

{% block content %}

{% load static %}

<style>
    #harvestTable tbody tr:hover {
        background-color: #f1f1f1;
        cursor: pointer;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination button {
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #e9e8e2;
        background-color: #e9e8e2;
        cursor: pointer;
    }

    .pagination button.active {
        font-weight: bold;
        background-color: #616646;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
    }

    .popup-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 50%;
        max-width: 500px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-close {
        cursor: pointer;
        float: right;
        font-size: 18px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }

    .delete-btn:disabled {
        background-color: #e9e8e2;
        color: #a0a0a0;
        cursor: not-allowed;
        opacity: 0.6;
    }
</style>

<div class="editable-area newPadding">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <h1>Colheitas</h1>
        <div>
            <button type="button" onclick="openAddHarvestModal(false)">
                <img src="{% static 'add.png' %}" title="Adicionar nova colheita" alt="add" style="height: 25px; width: auto;">
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters" style="margin-bottom: 20px;">
        <form method="get" id="filterForm" action="{% url 'harvest' %}">
            <div style="display: flex; gap: 10px;">
                <!-- Filtros -->
                <div class="form-group">
                    <label for="combinedFilter">Pesquisar:</label>
                    <input 
                        type="text" 
                        id="combinedFilter" 
                        name="combinedFilter" 
                        class="form-control" 
                        value="{{ request.GET.combinedFilter|default:'' }}" 
                        placeholder="Pesquisar por vinha, peso ou preço">
                </div>
                <div class="form-group">
                    <label for="filterPeriodoInicio">Período - Data Início:</label>
                    <input 
                        type="date" 
                        id="filterPeriodoInicio" 
                        name="filterPeriodoInicio" 
                        class="form-control" 
                        value="{{ request.GET.filterPeriodoInicio|default:'' }}">
                </div>
                <div class="form-group">
                    <label for="filterPeriodoFim">Período - Data Fim:</label>
                    <input 
                        type="date" 
                        id="filterPeriodoFim" 
                        name="filterPeriodoFim" 
                        class="form-control" 
                        value="{{ request.GET.filterPeriodoFim|default:'' }}">
                </div>
                <div class="form-group">
                    <label for="filterIsActive">Estado:</label>
                    <select 
                        id="filterIsActive" 
                        name="filterIsActive" 
                        class="form-control">
                        <option value="">Todos</option>
                        <option value="active" {% if request.GET.filterIsActive == 'active' %}selected{% endif %}>Ativo</option>
                        <option value="inactive" {% if request.GET.filterIsActive == 'inactive' %}selected{% endif %}>Inativo</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 24px;">
                    <button id="applyFilters" type="submit" class="button">Filtrar</button>
                    <button id="clear-filter" type="button" class="secondary-button">Limpar</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tabela -->
    <table id="harvestTable" class="table table-bordered">
        <thead>
            <tr>
                <th>Vinha</th>
                <th>Peso total (kg)</th>
                <th>Preço por tonelada (€)</th>
                <th>Data da última pesagem</th>
                <th>Período</th>
                <th>Previsão do fim da colheita</th>
                <th>Terminada</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="harvestBody">
            {% for colheita in colheitas %}
            <tr data-id="{{ colheita.colheitaid }}" 
                data-vinha-id="{{ colheita.vinha_id|default_if_none:'' }}" 
                data-peso-total="{{ colheita.peso_total }}" 
                data-preco-por-tonelada="{{ colheita.preco_por_tonelada }}" 
                data-periodo-inicio="{{ colheita.periodo_inicio|date:'Y-m-d' }}" 
                data-periodo-fim="{{ colheita.periodo_fim|date:'Y-m-d' }}" 
                data-previsao-fim="{{ colheita.previsao_fim_colheita|date:'Y-m-d' }}"
                data-periodo-ano="{{ colheita.periodo_ano|default:'' }}">
                <td>{{ colheita.vinha_nome }}</td>
                <td>{{ colheita.peso_total }}</td>
                <td>{{ colheita.preco_por_tonelada }}</td>
                <td>{{ colheita.data_ultima_pesagem|date:"Y-m-d" }}</td>
                <td>{{ colheita.periodo_inicio|date:"Y-m-d" }} a {{ colheita.periodo_fim|date:"Y-m-d" }}</td>
                <td>{{ colheita.previsao_fim_colheita|date:"Y-m-d" }}</td>
                <td>{{ colheita.terminada }}</td>
                <td>
                    <button title="Editar colheita" 
                            onclick="openAddHarvestModal(true, '{{ colheita.colheitaid }}')" 
                            type="button">
                        <img src="{% static 'edit.png' %}" alt="edit" style="height: 25px; width: auto;">
                    </button>
                    <button 
                        title="Inativar colheita" 
                        type="button" 
                        class="delete-btn" 
                        data-id="{{ colheita.colheitaid }}" 
                        {% if not colheita.isactive %}disabled{% endif %}>
                        <img src="{% static 'delete.png' %}" alt="delete" style="height: 25px; width: auto;">
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="no-data-message">Nenhuma colheita encontrada.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination" id="pagination"></div>
</div>

<!-- Modal Criar/Editar Colheita -->
<div id="addHarvestModal" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <span class="modal-close" onclick="closeAddHarvestModal()">&times;</span>
        <h2 id="addHarvestModalTitle">Adicionar Colheita</h2>
        <form id="addHarvestForm" onsubmit="submitHarvest(event)">
            {% csrf_token %}
            <input type="hidden" id="harvestId" name="harvestId" value="">
            <div class="form-group">
                <label for="harvestId">Vinha:</label>
                <select name="vinhaId" id="vinhaId" class="form-control" required>
                    <option value="">Selecione uma vinha</option>
                    {% for vinha in vinhas %}
                        <option value="{{ vinha.id }}">{{ vinha.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="harvestPesoTotal">Peso Total (kg):</label>
                <input type="number" id="harvestPesoTotal" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="harvestPrecoPorTonelada">Preço por Tonelada (€):</label>
                <input type="number" id="harvestPrecoPorTonelada" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="harvestPeriodoInicio">Período - Início:</label>
                <input type="date" id="harvestPeriodoInicio" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="harvestPeriodoFim">Período - Fim:</label>
                <input type="date" id="harvestPeriodoFim" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="harvestPeriodoAno">Ano do Período:</label>
                <input type="number" id="harvestPeriodoAno" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="harvestPrevisaoFim">Previsão do Fim:</label>
                <input type="date" id="harvestPrevisaoFim" class="form-control" required>
            </div>
            <button type="submit" class="button">Salvar</button>
        </form>
    </div>
</div>


<script>
const harvestTable = document.getElementById('harvestTable');

// Redireciona para os detalhes da colheita ao clicar em uma linha
harvestTable.addEventListener('click', function (event) {
    const targetRow = event.target.closest('tr'); // Obtém a linha clicada
    const isHeader = event.target.closest('thead'); // Ignora cliques no cabeçalho
    
    if (targetRow && !isHeader) { 
        const colheitaid = targetRow.getAttribute('data-id'); // Obtém o atributo "data-colheitaid"
        if (colheitaid) {
            // Redireciona para a URL correspondente
            window.location.href = `/backoffice/harvestdetail/${colheitaid}/`;
        }
    }
});

//FILTERS
document.getElementById('applyFilters').addEventListener('click', function() {
    const filterVinha = document.getElementById('filterVinha').value.toLowerCase();
    const filterCasta = document.getElementById('filterCasta').value.toLowerCase();
    const filterDataInicio = document.getElementById('filterDataInicio').value;
    const filterDataFim = document.getElementById('filterDataFim').value;
    const filterEstado = document.getElementById('filterEstado').value; // Obtemos o valor do filtro de estado

    const rows = document.querySelectorAll('#harvestTable tbody tr');

    rows.forEach(row => {
        const vinha = row.getAttribute('data-vinha').toLowerCase();
        const casta = row.getAttribute('data-casta').toLowerCase();
        const dataPesagem = row.getAttribute('data-data-pesagem');
        const isActive = row.getAttribute('data-isactive') === 'true'; // Pegamos o estado ativo/inativo da linha

        const matchesVinha = !filterVinha || vinha.includes(filterVinha);
        const matchesCasta = !filterCasta || casta.includes(filterCasta);
        const matchesDataInicio = !filterDataInicio || dataPesagem >= filterDataInicio;
        const matchesDataFim = !filterDataFim || dataPesagem <= filterDataFim;

        // Verifica o estado
        const matchesEstado =
            filterEstado === '' || // Se o filtro de estado não foi selecionado, corresponde a tudo
            (filterEstado === 'active' && isActive) || // Se o filtro é "ativo" e a linha é ativa
            (filterEstado === 'inactive' && !isActive); // Se o filtro é "inativo" e a linha é inativa

        if (matchesVinha && matchesCasta && matchesDataInicio && matchesDataFim && matchesEstado) {
            row.style.display = ''; // Mostra a linha
        } else {
            row.style.display = 'none'; // Oculta a linha
        }
    });
});

// Limpa os filtros e recarrega a página sem parâmetros
document.getElementById('clear-filter').addEventListener('click', function (event) {
    event.preventDefault(); // Evita o comportamento padrão do botão

    // Remove todos os parâmetros da URL
    const baseUrl = window.location.origin + window.location.pathname; // URL base sem parâmetros
    window.location.href = baseUrl; // Redireciona para a URL base
});

function openAddHarvestModal(isEdit = false, colheitaid = null) {
    const modal = document.getElementById('addHarvestModal');
    const modalTitle = document.getElementById('addHarvestModalTitle');
    const harvestForm = document.getElementById('addHarvestForm');
    const harvestVinha = document.getElementById('harvestVinha');

    modal.style.display = 'flex';

    if (isEdit) {
        modalTitle.textContent = 'Editar colheita';
        // Adicione o ID da colheita no campo oculto
        document.getElementById('harvestId').value = colheitaid;

        // Encontre a linha correspondente na tabela
        const row = document.querySelector(`tr[data-id="${colheitaid}"]`);
        if (row) {
            document.getElementById('harvestVinha').value = row.getAttribute('data-vinha-id');  // Preenche o dropdown com o ID correto
            document.getElementById('harvestPesoTotal').value = row.getAttribute('data-peso-total');
            document.getElementById('harvestPrecoPorTonelada').value = row.getAttribute('data-preco-por-tonelada');
            document.getElementById('harvestPeriodoInicio').value = row.getAttribute('data-periodo-inicio');
            document.getElementById('harvestPeriodoFim').value = row.getAttribute('data-periodo-fim');
            document.getElementById('harvestPrevisaoFim').value = row.getAttribute('data-previsao-fim');
            document.getElementById('harvestPeriodoAno').value = row.getAttribute('data-periodo-ano');  // Corrected
        }
    } else {
        modalTitle.textContent = 'Adicionar colheita';
        document.getElementById('harvestId').value = '';
        document.getElementById('harvestVinha').value = '';
        document.getElementById('harvestPesoTotal').value = '';
        document.getElementById('harvestPrecoPorTonelada').value = '';
        document.getElementById('harvestPeriodoInicio').value = '';
        document.getElementById('harvestPeriodoFim').value = '';
        document.getElementById('harvestPrevisaoFim').value = '';
        document.getElementById('harvestPeriodoAno').value = '';  // Clear the field
    }
}

function closeAddHarvestModal() {
    document.getElementById('addHarvestModal').style.display = 'none';
}

function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return null;
}

function submitHarvest(event) {
    event.preventDefault();
    
    const vinhaId = document.getElementById('harvestId').value;
    const isEdit = document.getElementById('addHarvestModalTitle').textContent === 'Editar colheita';
    const url = isEdit ? '/edit-harvest/' : '/create-harvest/';
    const harvestData = new FormData();
    harvestData.append("colheitaid", isEdit ? document.getElementById('harvestId').value : "");
    harvestData.append("vinhaId", vinhaId);
    harvestData.append("pesoTotal", document.getElementById('harvestPesoTotal').value);
    harvestData.append("precoPorTonelada", document.getElementById('harvestPrecoPorTonelada').value);
    harvestData.append("periodoInicio", document.getElementById('harvestPeriodoInicio').value);
    harvestData.append("periodoFim", document.getElementById('harvestPeriodoFim').value);
    harvestData.append("previsaoFimColheita", document.getElementById('harvestPrevisaoFim').value);
    harvestData.append("periodoAno", document.getElementById('harvestPeriodoAno').value);

    fetch('/create-harvest/', {
        method: 'POST',
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
        body: harvestData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert("Erro: " + data.message);
        }
    })
    .catch(error => {
        alert("Erro ao salvar: " + error);
    });
}


document.addEventListener('click', function (e) {
        if (e.target.closest('.delete-btn')) {
            const deleteButton = e.target.closest('.delete-btn');
            const harvestid = deleteButton.getAttribute('data-id');

            if (confirm('Tem certeza de que deseja inativar esta colheita?')) {
                fetch(`/inactivate_harvest/${harvestid}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const row = deleteButton.closest('tr');
                            row.dataset.isactive = 'false'; // Atualiza o atributo de estado
                            // Atualiza o botão para refletir o estado inativo
                            deleteButton.disabled = true;
                            deleteButton.classList.add('disabled');

                            const tableBody = document.getElementById('harvestBody');
                            filteredRows = Array.from(tableBody.querySelectorAll('tr'));
                            if (filteredRows.length === 0) {
                                const emptyRow = document.createElement('tr');
                                emptyRow.innerHTML = `
                                    <td colspan="2" class="no-data-message">Ainda não há colheitas adicionadas.</td>
                                `;
                                tableBody.appendChild(emptyRow);
                            } else {
                                // if (typeof updateTable === 'function') {
                                //     updateTable();
                                // }
                            }
                        } else {
                            alert(data.message || 'Erro ao inativar a colheita.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao excluir a colheita.');
                    });
            }
        }
    });

</script>

{% endblock %}
