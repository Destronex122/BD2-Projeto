{% extends 'base.html' %}

{% block title %}Mapa do campo{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<style>
    .leaflet-draw-draw-polyline,
    .leaflet-draw-draw-circlemarker,
    .leaflet-draw-draw-rectangle,
    .leaflet-draw-draw-circle {
        display: none !important;
    }
</style>

{% csrf_token %}
{% load static %}
<div class="newPadding">
    <div style="display:flex; justify-content: space-between;">
        <h1>Campos</h1>
    </div>
    <br>
    <div style="display:flex; justify-content: space-between;">
        <div id="map" style="width: 650px; height: 450px; margin-right:24px"></div>
        <div style="width:50%;">
            <table id="fields-table">
                <thead>
                    <tr>
                        <th>Nome do campo</th>
                        <th>Cidade</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if campos %}
                        {% for campo in campos %}
                            <tr>
                                <td>{{ campo.nome }}</td>
                                <td>{{ campo.cidade }}</td>
                                <td>
                                    <form method="GET" style="display:inline;">
                                        <button type="submit">
                                            <img src="{% static 'edit.png' %}" alt="edit" style="height: 25px; width: auto;">
                                        </button>
                                    </form>
                                    <form method="POST" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit">
                                            <img src="{% static 'delete.png' %}" alt="delete" style="height: 25px; width: auto;">
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="no-data-message">Ainda não há campos adicionados.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para adicionar ou editar um campo -->
    <div id="myModal" class="sidebar">
        <div class="p-3">
            <div style="text-align:right; padding:0px 24px;">
                <span class="close">&times;</span>
            </div>
            {% if campos.campoid != 0 %}
                <h2>Editar campo</h2>
            {% else %}
                <h2>Adicionar campo</h2>
            {% endif %}
            <div id="formContainer" style="margin-top: 15px;">
                <form method="POST">
                    {% csrf_token %}
                    <label for="name">Nome do campo:</label>
                    <input style="width: 50%;" type="text" id="name" name="nome" required>

                    <label for="morada">Morada:</label>
                    <input style="width: 50%;" type="text" id="morada" name="morada" required>

                    <label for="cidade">Cidade:</label>
                    <input style="width: 50%;" type="text" id="cidade" name="cidade" required>

                    <label for="coordinates">Coordenadas:</label>
                    <span id="coordinates" style="display: inline-block; width: 50%; padding: 5px; border: 1px solid #ccc; background-color: #f9f9f9;">Selecionar no mapa</span><br><br/>
                    <button type="submit">Guardar</button> 
                </form>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([39.615844061055384, -7.905762121081353], 6);

        map.removeControl(map.attributionControl);

        var layerControl = L.control.layers({}, {}).addTo(map);

        var osmLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        layerControl.addBaseLayer(osmLayer, 'Mapa');
        layerControl.addBaseLayer(googleSat, 'Visão de Satélite');

        var croplandMarkers = L.layerGroup().addTo(map);

        fetch('/load_croplands/', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addCroplandsToMap(data.campos);
                } else {
                    console.error('Erro ao carregar campos:', data.message);
                }
            })
            .catch(error => console.error('Erro ao carregar campos:', error));

        function addCroplandsToMap(campos) {
            campos.forEach(item => {
                if (item.coordenadas && item.coordenadas.lat && item.coordenadas.lng) {
                    const latLng = [item.coordenadas.lat, item.coordenadas.lng];

                    const markerLayer = L.marker(latLng)
                        .bindPopup(`${item.nome}<br>${item.cidade}`)
                        .on('click', function () {
                            openModalWithData(item);
                        });

                    croplandMarkers.addLayer(markerLayer);
                }
            });
        }

        layerControl.addOverlay(croplandMarkers, 'Marcadores de campos');

        var drawControl = new L.Control.Draw({
            draw: {
                marker: true,
                polygon: false,
                circle: false,
                rectangle: false,
                circlemarker: false,
                polyline: false
            },
            edit: false
        }).addTo(map);

        map.on('draw:created', function(e) {
            var type = e.layerType, layer = e.layer;
            var csrfToken = '{{ csrf_token }}';  

            if (type == 'marker') {
                document.getElementById('coordinates').textContent = `Lat: ${layer.getLatLng().lat}, Lng: ${layer.getLatLng().lng}`;
                openModal();

                document.querySelector('#formContainer form').onsubmit = function(event) {
                    event.preventDefault(); 

                    var nomeCampo = document.getElementById('name').value;
                    var morada = document.getElementById('morada').value;
                    var cidade = document.getElementById('cidade').value;
                    var coordenadas = layer.getLatLng(); // Coordenadas em formato lat/lng

                    fetch('/backoffice/save_marker/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            nome: nomeCampo,
                            morada: morada,
                            cidade: cidade,
                            coordenadas: coordenadas
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
                                <td>${data.campo.nome}</td>
                                <td>${data.campo.cidade}</td>
                                <td>
                                    <form method="GET" style="display:inline;">
                                        <button type="submit"><img src="{% static 'edit.png' %}" alt="edit" style="height: 25px; width: auto;"></button>
                                    </form>
                                    <form method="POST" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit"><img src="{% static 'delete.png' %}" alt="delete" style="height: 25px; width: auto;"></button>
                                    </form>
                                </td>
                            `;
                            document.querySelector('table tbody').appendChild(newRow);
                            croplandMarkers.addLayer(layer);
                            closeModal();
                        } else {
                            console.error('Erro ao salvar campo:', data.message);
                        }
                    })
                    .catch(error => console.error('Erro ao salvar campo:', error));
                }
            }
        });

        function openModalWithData(item) {
            document.getElementById('name').value = item.nome;
            document.getElementById('morada').value = item.morada || '';
            document.getElementById('cidade').value = item.cidade || '';
            document.getElementById('coordinates').textContent = `Lat: ${item.coordenadas.lat}, Lng: ${item.coordenadas.lng}`;
            openModal();
        }

        const modal = document.getElementById('myModal');
        const closeBtn = document.querySelector('.close');

        function openModal() {
            modal.classList.add('open');
        }

        function closeModal() {
            modal.classList.remove('open');
        }

        closeBtn.onclick = closeModal;

    </script>

</div>

{% endblock %}
