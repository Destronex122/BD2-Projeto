{% extends 'base.html' %}

{% block title %}Mapa do campo{% endblock %}

{% block content %}

{% load static %}


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<!-- DataTables CSS e JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>


<style>
    .leaflet-draw-draw-polyline,
    .leaflet-draw-draw-circlemarker,
    .leaflet-draw-draw-rectangle,
    .leaflet-draw-draw-circle {
        display: none !important;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination button {
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #e9e8e2;
        background-color: #e9e8e2;
        cursor: pointer;
    }

    .pagination button.active {
        font-weight: bold;
        background-color: #616646;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    .delete-btn:disabled {
        background-color: #e9e8e2; /* Cor de fundo desabilitada */
        color: #a0a0a0; /* Cor do ícone desabilitado */
        cursor: not-allowed; /* Mostra um cursor de bloqueio */
        opacity: 0.6; /* Torna o botão visualmente mais claro */
    }
</style>


<div class="newPadding">
    <div style="display:flex; justify-content: space-between;">
        <h1>Campos</h1>
    </div>
    <br>
    <div style="display:flex; justify-content: space-between;">
        <div id="map" style="width: 650px; height: 500px; margin-right:24px"></div>
        <div style="width:50%;">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <div class="form-group" style="flex: 1; min-width: 200px; margin-top:16px">
                    <label for="search-bar" style="display: block;">Nome do campo ou cidade:</label>
                    <input type="text" id="search-bar" placeholder="Pesquisar por nome ou cidade" style="width: 100%; padding: 8px; border: 1px solid #ccc;">
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="statusFilter" style="display: block;">Estados:</label>
                    <select id="statusFilter" class="form-control">
                        <option value="all" {% if filters.status == 'all' %}selected{% endif %}>Todos</option>
                        <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Ativos</option>
                        <option value="inactive" {% if filters.status == 'inactive' %}selected{% endif %}>Inativos</option>
                    </select>
                </div>
                
                <button id="apply-filter" style="margin-bottom: 15px;gap: 10px;align-items: center; margin-top:24px"">Aplicar</button>
                <button id="clear-filter" style="margin-bottom: 15px; gap: 10px; align-items: center; background-color: #e9e8e2; margin-top:24px"">Limpar</button>
            </div>
            <table id="fields-table">
                <thead>
                    <tr>
                        <th>Nome do campo</th>
                        <th>Cidade</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for campo in campos %}
                        <tr data-campoid="{{ campo.campoid }}"
                            data-isactive="{{ campo.isactive_cleaned|yesno:'true,false' }}">
                            <td>{{ campo.nome }}</td>
                            <td>{{ campo.cidade }}</td>
                            <td>
                                <button title="Editar campo" type="button" class="edit-btn" data-id="{{ campo.campoid }}">
                                    <img src="{% static 'edit.png' %}" title="Editar campo" alt="edit" style="height: 25px; width: auto;">
                                </button>
                                <button title="Eliminar campo" type="button" class="delete-btn" data-id="{{ campo.campoid }}" {% if not campo.isactive_cleaned %}disabled{% endif %}>
                                    <img src="{% static 'delete.png' %}" title="Eliminar campo" alt="delete" style="height: 25px; width: auto;">
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>
        
    </div>
    
</div>

    <!-- Modal para visualizar ou editar campos -->
    <div id="campoSidebar" class="sidebar" style="display: block;">
        <div class="p-3">
            <div style="text-align:right; padding:0px 24px;">
                <button id="closeSidebarButton" class="close">&times;</button>
            </div>
            <h2 id="campoSidebarTitle">Adicionar campo</h2>
            
            <div id="formContainer" style="display: block; margin-top: 15px;">
                <form id="campoForm" style="margin-top: 15px;">
                    {% csrf_token %}
                    <label for="campoName">Nome do campo:</label>
                    <input type="text" id="campoName" name="nome" required />
                    <label for="campoMorada">Morada:</label>
                    <input type="text" id="campoMorada" name="morada" required />
                    <label for="campoCidade">Cidade:</label>
                    <input type="text" id="campoCidade" name="cidade" required />
                    <label for="campoPais">País:</label>
                    <input type="text" id="campoPais" name="pais" required />
                    <label for="campoCoordinates">Coordenadas:</label>
                    <input type="text" id="campoCoordinates" name="coordenadas" readonly />
                    <div style="margin-top: 10px;">
                        <button id="closeSidebarButton" class="secondary-button" class="close">Cancelar</button>
                        <button type="submit">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchBar = document.getElementById("search-bar");
            const statusFilter = document.getElementById("statusFilter");
            const applyFilterButton = document.getElementById("apply-filter");
            const clearFilterButton = document.getElementById("clear-filter");
            const tableBody = document.getElementById("table-body");
            const paginationContainer = document.getElementById("pagination");
            const addFieldModal = document.getElementById("addFieldModal");
            const addFieldForm = document.getElementById("addFieldForm");
            const rowsPerPage = 5;
            let currentPage = 1;
            let filteredRows = [];
            let fieldsData = [];
    
            // Função para limpar os filtros
            function clearFilter() {
                searchBar.value = '';
                statusFilter.value = 'all';
                applyFilter();
            }
    
            // Inicializar o mapa
            const map = L.map('map').setView([39.615844061055384, -7.905762121081353], 6);
            map.removeControl(map.attributionControl);
    
            const layerControl = L.control.layers({}, {}).addTo(map);
            const osmLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }).addTo(map);
    
            const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });
    
            // Adicionar traduções ao mapa
            L.drawLocal.draw.toolbar.actions.text = 'Cancelar';
            L.drawLocal.draw.handlers.marker.tooltip.start = 'Clique no mapa para adicionar o marcador.';
            L.drawLocal.draw.toolbar.buttons.marker = 'Adicionar um marcador';
    
            layerControl.addBaseLayer(osmLayer, 'Mapa');
            layerControl.addBaseLayer(googleSat, 'Visão de Satélite');
    
            const featureGroup = new L.FeatureGroup().addTo(map);
    
            const drawControl = new L.Control.Draw({
                draw: {
                    marker: true,
                    polygon: false,
                    circle: false,
                    rectangle: false,
                    circlemarker: false,
                    polyline: false
                },
                edit: {
                    featureGroup: featureGroup
                }
            }).addTo(map);

            map.on('draw:created', function (e) {
                const layer = e.layer;
                const coordinates = layer.getLatLng();
                featureGroup.addLayer(layer);

                // Converte as coordenadas para uma string JSON com aspas duplas
                const coordinatesJSON = JSON.stringify({ lat: coordinates.lat, lng: coordinates.lng });

                // Atribui ao campo de coordenadas
                const campoCoordinates = document.getElementById('campoCoordinates');
                campoCoordinates.value = coordinatesJSON;

                // Abre a sidebar
                openSidebar(false, { coordenadas: coordinates });
            });
    
            function openSidebar(isEdit = false, campo = null) {
                const sidebar = document.getElementById('campoSidebar');
                const title = document.getElementById('campoSidebarTitle');
                const campoName = document.getElementById('campoName');
                const campoMorada = document.getElementById('campoMorada');
                const campoCidade = document.getElementById('campoCidade');
                const campoPais = document.getElementById('campoPais');
                const campoCoordinates = document.getElementById('campoCoordinates');
                const campoForm = document.getElementById('campoForm');
                
                sidebar.style.display = 'flex';
                sidebar.removeAttribute('inert'); // Remove inert para permitir interação

                if (isEdit && campo) {
                    title.textContent = 'Editar campo';
                    campoName.value = campo.nome || '';
                    campoMorada.value = campo.morada || '';
                    campoCidade.value = campo.cidade || '';
                    campoPais.value = campo.pais || '';
                    campoCoordinates.value = campo.coordenadas
                        ? JSON.stringify(campo.coordenadas).replace(/'/g, '"')
                        : '{"lat":null,"lng":null}';
                    campoForm.dataset.isEdit = 'true';
                    campoForm.dataset.campoid = campo.campoid;
                } else {
                    title.textContent = 'Adicionar campo';
                    campoName.value = '';
                    campoMorada.value = '';
                    campoCidade.value = '';
                    campoPais.value = '';
                    campoCoordinates.value = campo.coordenadas
                        ? JSON.stringify(campo.coordenadas).replace(/'/g, '"')
                        : '{"lat":null,"lng":null}';
                    campoForm.dataset.isEdit = 'false';
                    delete campoForm.dataset.campoid;
                }

                setTimeout(() => sidebar.classList.add('open'), 10);
            }

           // Close the sidebar
            function closeSidebar() {
                const sidebar = document.getElementById('campoSidebar');
                sidebar.style.display = 'none'; // Fecha a sidebar alterando o estilo
                sidebar.classList.remove('open');
            }

            // Event listeners para fechar a sidebar
            document.getElementById('closeSidebarButton').addEventListener('click', closeSidebar); // Botão "X"
            document.querySelector('.secondary-button').addEventListener('click', closeSidebar); // Botão "Cancelar"

            function addRowToTable(campo) {
                const row = document.createElement('tr');
                row.dataset.id = campo.campoid;
                row.dataset.name = campo.nome.toLowerCase();
                row.dataset.city = campo.cidade.toLowerCase();
                row.dataset.isactive = String(campo.isactive);
    
                row.innerHTML = `
                    <td>${campo.nome}</td>
                    <td>${campo.cidade}</td>
                    <td>
                        <button class="edit-btn" data-id="${campo.campoid}">
                            <img src="{% static 'edit.png' %}" alt="Edit" style="height: 25px; width: auto;">
                        </button>
                        <button class="delete-btn" data-id="${campo.campoid}" ${campo.isactive ? '' : 'disabled'}>
                            <img src="{% static 'delete.png' %}" alt="Delete" style="height: 25px; width: auto;">
                        </button>
                    </td>
                `;
                tableBody.appendChild(row); // Adicionar à tabela
                filteredRows = Array.from(tableBody.querySelectorAll('tr')); // Atualizar os dados da tabela e aplicar filtros
            	applyFilter();
            }
    
            function updateTable() {
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
    
                Array.from(tableBody.querySelectorAll('tr')).forEach(row => (row.style.display = 'none'));
                filteredRows.slice(startIndex, endIndex).forEach(row => (row.style.display = ''));
    
                renderPaginationButtons();
            }

            
    
            function renderPaginationButtons() {
                paginationContainer.innerHTML = '';
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.classList.add('pagination-button');
                    if (i === currentPage) button.classList.add('active');
                    button.addEventListener('click', () => {
                        currentPage = i;
                        updateTable();
                    });
                    paginationContainer.appendChild(button);
                }
            }
    
            // Função para inativar um campo
            document.addEventListener('click', function (e) {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    const campoid = deleteButton.dataset.id;
                    if (confirm('Tem certeza de que deseja inativar este campo?')) {
                        fetch(`/delete_campo/${campoid}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Erro HTTP: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.status === 'success') {
                                    deleteButton.disabled = true;
                                    deleteButton.closest('tr').dataset.isactive = 'false';
                                    alert('Campo inativado com sucesso.');
                                    updateTable();
                                } else {
                                    alert(`Erro: ${data.message}`);
                                }
                            })
                            .catch(error => console.error('Erro ao inativar campo:', error));
                    }
                    return;
                }

                
                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    const campoid = editButton.dataset.id;
                    fetch(`/get_campo_data/${campoid}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao buscar dados do campo');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                openSidebar(true, data.campo);
                            } else {
                                alert(data.message || 'Erro ao carregar dados do campo.');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao buscar campo:', error);
                            alert('Ocorreu um erro ao carregar os dados do campo.');
                        });
                }
            });
    
            fetch('/load_croplands/', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        tableBody.innerHTML = '';
                        featureGroup.clearLayers();
    
                        data.campos.forEach(item => {
                            // Adicionar marcador apenas se as coordenadas forem válidas
                            if (item.coordenadas && item.coordenadas.lat && item.coordenadas.lng) {
                                const latLng = [item.coordenadas.lat, item.coordenadas.lng];
                                const marker = L.marker(latLng).bindPopup(`<b>${item.nome}</b>`);
                                featureGroup.addLayer(marker);
                            } else {
                                console.warn('Coordenadas inválidas ou ausentes para o campo:', item.nome || 'Desconhecido');
                            }
                            addRowToTable(item);
                        });
    
                        initPagination();
                        applyFilter();
                    } else {
                        console.error('Erro ao carregar campos:', data.message);
                    }
                })
                .catch(error => console.error('Erro ao carregar campos:', error));
    
            function applyFilter() {
                const query = searchBar.value.toLowerCase().trim();
                const status = statusFilter.value;
    
                filteredRows = Array.from(tableBody.querySelectorAll('tr')).filter(row => {
                    const name = row.dataset.name;
                    const city = row.dataset.city;
                    const isActive = row.dataset.isactive === 'true';
    
                    const matchesStatus =
                        status === 'all' ||
                        (status === 'active' && isActive) ||
                        (status === 'inactive' && !isActive);
    
                    const matchesQuery = name.includes(query) || city.includes(query);
    
                    return matchesStatus && matchesQuery;
                });
    
                currentPage = 1;
                updateTable();
            }
    
            applyFilterButton.addEventListener('click', applyFilter);
            clearFilterButton.addEventListener('click', clearFilter);
    
            function initPagination() {
                filteredRows = Array.from(tableBody.querySelectorAll('tr'));
                updateTable();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('campoForm');

            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Evita o envio padrão do formulário

                // Identifica se é edição ou criação
                const isEdit = form.dataset.isEdit === 'true';
                const campoid = form.dataset.campoid; // ID do campo, se for edição
                
                // Obtém os valores do formulário
                const nome = document.getElementById('campoName').value.trim();
                const morada = document.getElementById('campoMorada').value.trim();
                const cidade = document.getElementById('campoCidade').value.trim();
                const pais = document.getElementById('campoPais').value.trim();
                const coordenadas = document.getElementById('campoCoordinates').value.trim();

                // Valida campos obrigatórios
                if (!nome || !morada || !cidade || !pais || !coordenadas) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }

                // URL e método HTTP para a operação
                const url = isEdit ? `/update_campo/${campoid}/` : '/save_marker/';
                const method = isEdit ? 'PUT' : 'POST';

                // Valida e prepara coordenadas
                let parsedCoordinates;
                try {
                    parsedCoordinates = JSON.parse(coordenadas); // Certifica-se de que é um objeto JSON
                    if (!parsedCoordinates.lat || !parsedCoordinates.lng) {
                        throw new Error('As coordenadas devem conter "lat" e "lng".');
                    }
                } catch (error) {
                    alert('As coordenadas estão no formato inválido. Por favor, corrija.');
                    return;
                }

                // Faz a solicitação ao backend
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            nome,
                            morada,
                            cidade,
                            pais,
                            coordenadas: parsedCoordinates 
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert(isEdit ? 'Campo editado com sucesso!' : `Campo criado com sucesso!`);
                        form.reset();
                        document.getElementById('campoSidebar').style.display = 'none';
                        if (!isEdit) {
                            addRowToTable(result.campo);
                        }
                    } else {
                        alert(result.message || 'Erro ao salvar o campo.');
                    }
                } catch (error) {
                    console.error('Erro na solicitação:', error);
                    alert('Ocorreu um erro ao salvar o campo.');
                }
            });
        });
    </script>
    


{% endblock %}
